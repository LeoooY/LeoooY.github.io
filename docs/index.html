<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.58">
<title data-react-helmet="true">TCP3次握手和4次挥手 | DocsShare</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="TCP3次握手和4次挥手 | DocsShare"><meta data-react-helmet="true" name="description" content="TCP3次握手和4次挥手"><meta data-react-helmet="true" property="og:description" content="TCP3次握手和4次挥手"><meta data-react-helmet="true" property="og:url" content="https://leoooy.github.io//docs/"><link data-react-helmet="true" rel="shortcut icon" href="/img/leo.png"><link data-react-helmet="true" rel="canonical" href="https://leoooy.github.io//docs/"><link rel="stylesheet" href="/styles.5961654d.css">
<link rel="preload" href="/styles.42bc322c.js" as="script">
<link rel="preload" href="/runtime~main.e8476738.js" as="script">
<link rel="preload" href="/main.40fc54e8.js" as="script">
<link rel="preload" href="/common.ee045f54.js" as="script">
<link rel="preload" href="/2.358b1822.js" as="script">
<link rel="preload" href="/3.2cdabb68.js" as="script">
<link rel="preload" href="/1be78505.b7264bde.js" as="script">
<link rel="preload" href="/28.c35099c0.js" as="script">
<link rel="preload" href="/20ac7829.809bff99.js" as="script">
<link rel="preload" href="/17896441.6709d3b9.js" as="script">
<link rel="preload" href="/4e78d65c.88b0a6e4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/leo.png" alt="My Site Logo"><strong class="navbar__title">My DocsShare</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Notes</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/LeoooY" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://juejin.im/user/5bebc171e51d4511a8090edb/posts" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">掘金</a><a href="https://twitter.com/LeoY233" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Twitter</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/leo.png" alt="My Site Logo"><strong class="navbar__title">My DocsShare</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs">Notes</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/LeoooY" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://juejin.im/user/5bebc171e51d4511a8090edb/posts" target="_blank" rel="noopener noreferrer" class="menu__link">掘金</a></li><li class="menu__list-item"><a href="https://twitter.com/LeoY233" target="_blank" rel="noopener noreferrer" class="menu__link">Twitter</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp" role="complementary"><div class="sidebar_1kLs"><div class="menu menu--responsive menu_w2sC"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Network</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/">TCP3次握手和4次挥手</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FE</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Browser</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/FE/Browser/doc-Blink内核是如何工作的">[译] Blink内核是如何工作的?</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">React</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/FE/React/doc-ReactHooks使用心得">ReactHooks使用心得</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div class="container padding-vert--lg docItemWrapper_1cc7"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">TCP3次握手和4次挥手</h1></header><div class="markdown"><p>TCP3次握手和4次挥手</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp的连接建立（tcp3次握手）"></a>TCP的连接建立（TCP3次握手）<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp的连接建立（tcp3次握手）" title="Direct link to heading">#</a></h3><p>TCP3次握手 three way handshaks
其实是在一次握手中交换了三个报文，更准确的翻译是“三报文握手”（RFC973 three way/three message handshaks）
TCP建立连接的过程叫做握手，握手需要在客户端和服务器之间交换三个TCP报文段</p><p><img src="/img/blog/2020.07.08.TCP3%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C4%E6%AC%A1%E6%8C%A5%E6%89%8B/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png"></p><ul><li>最初两端的TCP进程都处于CLOSED（关闭）状态。</li></ul><p>在本例子中，A主动打开连接，B被动打开连接。</p><ul><li>服务器B启动，B的TCP服务器进程会先创建<strong>传输控制块 TCB</strong>，准备接受客户端的连接请求，然后服务器进程就处于 <code>LISTEN 收听</code> 状态，等待客户的连接请求，如有则做出响应。</li><li>（第一次）客户端A的TCP进程，在准备建立TCP连接之前，先会创建<strong>传输控制模块 TCB</strong>。建立连接，向B发出连接请求报文段。<ul><li>此时报文首部的同步位 <code>SYN=1</code> , 同时选择一个初始序号 <code>seq=x</code> 。</li><li>报文： <code>SYN=1 seq=x</code></li><li>A的TCP进程进入 <code>SYN-SENT 同步已发送</code> 状态</li></ul></li></ul><blockquote><p>传输控制模块 TCB（Transmission Control Block）存储了每一个连接中的重要信息，如：TCP连接表，指向发送和接受缓存的指针，指向重传队列的指针，当前的发送和接收序号等等</p></blockquote><ul><li>（第二次）服务器B收到连接请求报文后，若同意建立连接，则向A发出确认。<ul><li>在报文中把 <code>SYN</code> 位和 <code>ACK</code> 位都置1，确认号是 <code>ack=x+1</code> ,同时也选择一个初始序号 <code>seq = y</code> 。</li><li>报文： <code>SYN=1 ACK=1 seq=y ack=x+1</code></li><li>此时服务器B的TCP进程进入 <code>SYN-RCVD 同步收到</code> 状态</li></ul></li></ul><blockquote><p>TCP标准规定，SYN报文段（即SYN=1的报文段）不能携带数据，但要消耗一个掉序号seq</p></blockquote><ul><li>（第三次）客户端A收到B的确认（第二次握手）后，还要向服务器B给出确认。<ul><li>确认报文段的ACK置1，确认号 <code>ack = y + 1</code> ,而自己的序号 <code>seq = x + 1</code> 。</li><li>报文： <code>ACK=1 seq=x+1 ack=y+1 </code></li><li>此时，TCP的连接已经建立，A进入 <code>ESTABLISHED</code> 状态</li></ul></li></ul><blockquote><p>TCP标准规定，ACK报文段可以携带数据，但如果不携带数据则不消耗序号。不携带数据的话，下一个报文段的序号仍是 <code>seq=x+1</code></p><ul><li>B收到A的确认后也进入 <code>ESTABLISHED</code> 状态</li></ul></blockquote><blockquote><p>第二次握手的报文可以拆成两个报文段，先发送一个确认报文段 <code>ACK=1 ack=x+1</code> , 再发送一个同步报文段 <code>SYN=1 seq=y</code> , 这样的过程就变成了<strong>四次握手</strong>，但效果是一样的</p></blockquote><p>为什么A最后还要发送一次确认呢？（为什么是三次握手呢？）
为了防止A发出的已失效的连接请求报文突然又传送到了B而产生错误：</p><ul><li>正常情况：<ul><li>A发出连接请求，但是因请求报文丢失而未收到确认，于是A再重传一次连接请求。</li><li>重传的请求收到了确认，建立起了连接</li><li>数据传输完成，释放了连接。A一共发了两个连接请求，第一个丢失，第二个到达B，正常，未产生“已失效的连接请求报文”。</li></ul></li><li>异常情况：<ul><li>A发出的第一个连接请求并没有丢失，而是在因为某些原因滞留了，而延迟到达。</li><li>这本是一个失效的连接请求，但B收到此请求后会误以为是A发出的一个新的连接请求，于是向A发出确认报文，同意建立连接。</li><li>若此时不采用第三次确认再建立连接的话，只要B发出确认，新的连接就建立了。但由于这并不是A的有效连接请求，所以A不会理睬B的确认，也不会向B发送数据，B却以为新的运输连接已经建立了，并一直等待A发来的数据，B的许多资源就白白浪费了。</li><li>三次握手可以防止上述问题，在上述情况下，A不会向B的确认发出确认。B没有收到确认就知道A没有要求建立连接。</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="tcp的连接释放（tcp4次挥手）"></a>TCP的连接释放（TCP4次挥手）<a aria-hidden="true" tabindex="-1" class="hash-link" href="#tcp的连接释放（tcp4次挥手）" title="Direct link to heading">#</a></h3><p>TCP连接释放的过程更复杂</p><p><img src="/img/blog/2020.07.08.TCP3%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C4%E6%AC%A1%E6%8C%A5%E6%89%8B/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png"></p><ul><li>数据传输结束后，通信双方AB都可以释放连接，释放之前都处于 <code>ESTASLISHED</code> 状态，以A释放连接为例：</li><li>（第一次）A的应用进程向TCP发出连接释放报文段，并停止再发送数据，主动关闭TCP连接。<ul><li>A把连接释放报文段首部的终止控制位FIN置1，序号seq=u,u等于A前面已传送过的数据的最后一个字节的序号加1。</li><li>报文： <code>FIN=1 seq=u</code></li><li>此时A进入 <code>FIN-WAIT-1</code> 状态</li></ul></li></ul><blockquote><p>TCP标准规定，FIN报文段（即SYN=1的报文段）即使不携带数据，也要消耗一个掉序号seq</p></blockquote><ul><li><p>(第二次)B收到连接释放报文后即发出确认，</p><ul><li>确认号是 <code>ack=u+1</code> ,报文段自己的序号取 <code>seq=v</code> ,v等于B前面已传送过的数据的最后一个字节的序号加1</li><li>报文： <code>ACK=1 seq=v ack=u+1</code></li><li>此时B进入 <code>CLOSE-WAIT</code> 状态,TCP进程通知应用进程，A到B方向的连接就释放掉了。</li><li>A收到B发出的确认后（第二次挥手），就进入 <code>FIN-WAIT-2</code> 状态，等待B发出的连接释放报文段</li></ul></li><li><p>此时的TCP连接处于<strong>半关闭 half-close</strong>状态，即A已经没有数据要发送了，但B若发送数据，A仍要接收。</p></li><li><p>（第三次）若B已经没有要向A发送的数据，其应用进程就通知TCP释放连接。</p><ul><li>此时B的连接释放报文须使 <code>FIN=1</code> ，假设半关闭状态又发送了一些数据报，现在的序号为 <code>seq=w</code> ,且须重复上次的确认号 <code>ack=u+1</code></li><li>报文： <code>FIN=1 ACK=1 seq=w ack=u+1</code></li><li>此时B进入 <code>LAST-ACK 最后最后确认状态</code> ，等待A的确认    </li></ul></li><li><p>（第四次）A在收到B的连接释放报文段后，必须对此发出确认</p><ul><li>在确认报文段中把ACK置1，确认号 <code>ack=w+1</code> ,而自己的序号是 <code>seq=u+1</code></li><li>报文: <code>ACK=1 seq=u+1 ack=w+1</code></li><li>A进入 <code>TIME-WAIT 时间等待</code> 状态。注意，此时TCP连接还没有释放掉。必须经过<strong>时间等待计时器 TIME-WAIT-TIMER</strong>设置的时间2MSL后，A才进入到 <code>CLOSE</code> 状态</li><li>而B收到A的确认就进入了 <code>CLOSE</code> 状态</li></ul></li></ul><blockquote><p>时间MSL叫做<strong>最长报文段寿命 Maximun Segment Life</strong>, RFC 793建议设置为2分钟。TCP允许不同的实现可根据不同的具体情况使用更小的MSL值</p></blockquote><ul><li>A进入 <code>CLOSE</code> 状态，撤销相应的传输控制块TCB后，就结束了这次的TCP</li></ul><p>为什么A在 <code>TIME-WAIT</code> 状态必须等待2MSL的时间？</p><ul><li>1 为了保证A发送的最后一个ACK报文段能够到达B<ul><li>这个确认报文段(第四次挥手)可能丢失，而 <code>LAST-ACK</code> 状态的B若收不到这个确认就会超时重传(第三次挥手) <code>FIN+ACK</code> ，接着A重传(第四次挥手)一次确认，重置2MSL计时器。最后A和B都正常 <code>CLOSE</code> 。</li><li>若A在(第四次挥手)确认报文后不等待就进入 <code>CLOSE</code> ,但确认报文丢失时，就收不到B的重传(第三次挥手) <code>FIN+ACK</code> ，这样B就无法正常进入 <code>CLOSE</code> 状态。</li></ul></li><li>2 防止“已失效的连接请求报文”出现在本连接中<ul><li>A在发送完最后一个确认(第四次挥手)后，再经过2MSL，就可以使本次TCP连接中所产生的所有报文段都从网络中消失。下一次的新TCP就不会出现“已失效的连接请求报文”</li></ul></li></ul><p>除了时间等待计时器外，TCP还有个<strong>保活计时器 keepalive timer</strong>。设想这种情况：
客户端与服务器建立了TCP连接，但后来客户端突然出现故障，显然服务器以后就不能再收到客户端的数据，因此需要有个机制使得服务器不要再白白等下去浪费资源，这个机制就是<strong>保活计时器</strong>。服务器每收到一次客户端数据就重置保活计时器，时间的设置通常是两小时。若两小时没有收到客户数据，服务器就发送一个探测报文，每隔75s发送一次，连续10个仍无响应就认为客户端出现故障，关闭这个TCP连接。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="参考"></a>参考<a aria-hidden="true" tabindex="-1" class="hash-link" href="#参考" title="Direct link to heading">#</a></h3><ul><li>《计算机网络》谢希仁</li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/FE/Browser/doc-Blink内核是如何工作的"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">[译] Blink内核是如何工作的? »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#tcp的连接建立（tcp3次握手）" class="table-of-contents__link">TCP的连接建立（TCP3次握手）</a></li><li><a href="#tcp的连接释放（tcp4次挥手）" class="table-of-contents__link">TCP的连接释放（TCP4次挥手）</a></li><li><a href="#参考" class="table-of-contents__link">参考</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="text--center"><div>Copyright © 2020 LeoY233. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.42bc322c.js"></script>
<script src="/runtime~main.e8476738.js"></script>
<script src="/main.40fc54e8.js"></script>
<script src="/common.ee045f54.js"></script>
<script src="/2.358b1822.js"></script>
<script src="/3.2cdabb68.js"></script>
<script src="/1be78505.b7264bde.js"></script>
<script src="/28.c35099c0.js"></script>
<script src="/20ac7829.809bff99.js"></script>
<script src="/17896441.6709d3b9.js"></script>
<script src="/4e78d65c.88b0a6e4.js"></script>
</body>
</html>