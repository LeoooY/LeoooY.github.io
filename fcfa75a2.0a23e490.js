(window.webpackJsonp=window.webpackJsonp||[]).push([[167],{222:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return p}));var a=n(2),r=n(6),i=(n(0),n(228)),o={},c={unversionedId:"FE/NodeJs/nodeJs\u6784\u5efaweb\u5e94\u7528\u670d\u52a1\u5668/koa\u4f7f\u7528/index",id:"FE/NodeJs/nodeJs\u6784\u5efaweb\u5e94\u7528\u670d\u52a1\u5668/koa\u4f7f\u7528/index",isDocsHomePage:!1,title:"index",description:"- \u5b89\u88c5",source:"@site/docs/FE/NodeJs/nodeJs\u6784\u5efaweb\u5e94\u7528\u670d\u52a1\u5668/koa\u4f7f\u7528/index.md",slug:"/FE/NodeJs/nodeJs\u6784\u5efaweb\u5e94\u7528\u670d\u52a1\u5668/koa\u4f7f\u7528/index",permalink:"/docs/FE/NodeJs/nodeJs\u6784\u5efaweb\u5e94\u7528\u670d\u52a1\u5668/koa\u4f7f\u7528/index",version:"current"},l=[{value:"\u5b89\u88c5",id:"\u5b89\u88c5",children:[]},{value:"\u7279\u70b9",id:"\u7279\u70b9",children:[]},{value:"\u4f7f\u7528\u5165\u95e8",id:"\u4f7f\u7528\u5165\u95e8",children:[]}],s={rightToc:l};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#%E5%AE%89%E8%A3%85"}),"\u5b89\u88c5")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#%E7%89%B9%E7%82%B9"}),"\u7279\u70b9")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8"}),"\u4f7f\u7528\u5165\u95e8")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#"})),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#applisten"}),"app.listen()")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#appcallback"}),"app.callback()")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#appusefunc-aysnc-func"}),"app.use(func| aysnc func)")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#appkeys"}),"app.keys=")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#appcontext"}),"app.context")))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#context-ctx"}),Object(i.b)("inlineCode",{parentName:"a"},"Context")," ",Object(i.b)("inlineCode",{parentName:"a"},"ctx")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctx-api"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx api")),Object(i.b)("ul",{parentName:"li"},Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxreq"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.req"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxres"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.res"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxrequest"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.request"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxresponse"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.response"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxstate"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.state"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxapp"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.app"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxappemit"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.app.emit"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxcookiesgetname-options"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.cookies.get(name, [options])"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxcookiessetname-value-options"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.cookies.set(name, value, [options])"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxthrowstatus-msg-properties"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.throw([status], [msg], [properties])"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#ctxassertvalue-status-msg-properties"}),Object(i.b)("inlineCode",{parentName:"a"},"ctx.assert(value, [status], [msg], [properties])"))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#xctxrespond"}),"[x]",Object(i.b)("inlineCode",{parentName:"a"},"ctx.respond"))))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#request"}),"Request")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#response"}),"Response")))),Object(i.b)("li",{parentName:"ul"},Object(i.b)("a",Object(a.a)({parentName:"li"},{href:"#%E5%B8%B8%E7%94%A8midware"}),"\u5e38\u7528",Object(i.b)("inlineCode",{parentName:"a"},"midware")))),Object(i.b)("h3",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"npm i koa\n")),Object(i.b)("h3",{id:"\u7279\u70b9"},"\u7279\u70b9"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"array of middleware functions")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"stack-like manner")," \u5148\u8fdb\u540e\u51fa"),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"async functions"))),Object(i.b)("h3",{id:"\u4f7f\u7528\u5165\u95e8"},"\u4f7f\u7528\u5165\u95e8"),Object(i.b)("h3",{id:""}),Object(i.b)("blockquote",null,Object(i.b)("p",{parentName:"blockquote"},"When a middleware invokes ",Object(i.b)("inlineCode",{parentName:"p"},"next()")," the function ",Object(i.b)("strong",{parentName:"p"},"suspends and passes control to the next middleware")," defined. After there are ",Object(i.b)("strong",{parentName:"p"},"no more middleware")," to execute downstream, the stack will ",Object(i.b)("strong",{parentName:"p"},"unwind")," and each middleware is ",Object(i.b)("strong",{parentName:"p"},"resumed")," to perform its upstream behaviour."),Object(i.b)("pre",{parentName:"blockquote"},Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"app.use(async (ctx, next) => {\n    const start = Date.now();\n"))),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"await next();       // \u6267\u884c\u5230\u6b64\u88ab\u963b\u585e\uff0c\u6267\u884c\u4ea4\u7ed9\u6808\u4e2d\u4e0b\u4e00\u4e2a\u4e2d\u95f4\u4ef6\n                    // \u76f4\u5230\u6240\u6709\u4e2d\u95f4\u4ef6await\u4e4b\u524d\u7684\u90e8\u5206\u90fd\u6267\u884c\u5b8c\u6210\uff08\u6216\u8005\u4e2d\u95f4\u4ef6\u6ca1\u6709await\uff09\n                    // \u6309\u6808\u7684\u987a\u5e8f\uff08\u5148\u8fdb\u540e\u51fa\uff09\u7ee7\u7eed\u6267\u884cawait\u4e4b\u540e\u7684\u4ee3\u7801\nconst ms = Date.now() - start;\nctx.set('X-Response-Time', `${ms}ms`);\n")),Object(i.b)("p",null,"});"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n#### app.listen()\n\n\n")),Object(i.b)("p",null,"const Koa = require('koa');\nconst app = new Koa();\napp.listen(3000);"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\nis suger to \n\n")),Object(i.b)("p",null,"const http = require('http');\nconst Koa = require('koa');\nconst app = new Koa();\nhttp.createServer(app.callback()).listen(3000);"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\neg:\n")),Object(i.b)("p",null,"const http = require('http');\nconst https = require('https');\nconst Koa = require('koa');\nconst app = new Koa();\nhttp.createServer(app.callback()).listen(3000);\nhttps.createServer(app.callback()).listen(3001);"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n#### app.callback()\n>Return a callback function suitable for the http.createServer() method to handle a request. You may also use this callback function to mount your Koa app in a Connect/Express app.\n\n#### app.use(func| aysnc func)\n>Add the given middleware function to this application. See Middleware for more information.\n\n#### app.keys=\nSet signed cookie keys.\n\n")),Object(i.b)("p",null,"app.keys = ","['im a newer secret', 'i like turtle']",";\napp.keys = new KeyGrip(","['im a newer secret', 'i like turtle']",", 'sha256');"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n#### app.context\n>`app.context` is the prototype from which `ctx` is created. You may add additional properties to `ctx` by editing `app.context`. This is useful for adding properties or methods to ctx to be used across your entire app, which may be more performant (no middleware) and/or easier (fewer require()s) at the expense of relying more on ctx, which could be considered an anti-pattern.\n\n")),Object(i.b)("p",null,"app.context.db = db();"),Object(i.b)("p",null,"app.use(async ctx => {\nconsole.log(ctx.db);\n});"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\nNote:\n- Many properties on ctx are defined using getters, setters, and Object.defineProperty(). You can only edit these properties (not recommended) by using Object.defineProperty() on app.context. See https://github.com/koajs/koa/issues/652.\n- Mounted apps currently use their parent's ctx and settings. Thus, mounted apps are really just groups of middleware.\n\n### `Context` `ctx`\n>A Koa Context encapsulates node's `request` and `response` objects into a single object which provides many helpful methods for writing web applications and APIs.\n\n")),Object(i.b)("p",null,"app.use(async ctx => {\nctx; // is the Context\nctx.request; // is a Koa Request\nctx.response; // is a Koa Response\n});"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),">**Many of the context's accessors and methods simply delegate to their ctx.request or ctx.response equivalents for convenience**, and are otherwise identical. For example ctx.type and ctx.length delegate to the response object, and ctx.path and ctx.method delegate to the request.\n\n#### `ctx api`\n\n##### `ctx.req`\nNode's request object.\n\n##### `ctx.res`\nNode's response object.\nBypassing Koa's response handling is not supported. Avoid using the following node properties:\n- res.statusCode\n- res.writeHead()\n- res.write()\n- res.end()\n\n##### `ctx.request`\nA Koa Request object.\n\n##### `ctx.response`\nA Koa Response object.\n\n##### `ctx.state`\nThe recommended namespace for passing information through middleware and to your frontend views.\n")),Object(i.b)("p",null,"ctx.state.user = await User.find(id);"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),'\n##### `ctx.app`\nApplication instance reference.\n\n##### `ctx.app.emit`\n>Koa applications extend an internal `EventEmitter`. ctx.app.emit emits an event with a type, defined by the first argument. For each event you can hook up "listeners", which is a function that is called when the event is emitted. Consult the error handling docs for more information.\n\n\n##### `ctx.cookies.get(name, [options])`\n\n##### `ctx.cookies.set(name, value, [options])`\n\n##### `ctx.throw([status], [msg], [properties])`\nHelper method to throw an error with a .status property defaulting to 500 that will allow Koa to respond appropriately. The following combinations are allowed:\n')),Object(i.b)("p",null,"ctx.throw(400);\nctx.throw(400, 'name required');\nctx.throw(400, 'name required', { user: user });"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"`ctx.throw(400, 'name required')` is equivalent to\n\n")),Object(i.b)("p",null,"const err = new Error('name required');\nerr.status = 400;\nerr.expose = true;\nthrow err;"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"##### `ctx.assert(value, [status], [msg], [properties])`\n\n##### [x]`ctx.respond`\nUsing this property is considered a **hack** and is only a convenience to those wishing to use traditional fn(req, res) functions and middleware within Koa.\n\n\n#### Request\n")),Object(i.b)("p",null,'request.header / request.headers\nrequest.method\nrequest.url\nrequest.href\nrequest.query\nrequest.querystring\nrequest.search\nrequest.host\nrequest.fresh / request.stale\nrequest.protocol\nrequest.secure  //ctx.protocol == "https"\nrequest.ip\nrequest.ips  //When X-Forwarded-For is present and app.proxy is enabled an array of these ips is returned, ordered from upstream -> downstream. When disabled an empty array is returned.\nrequest.is(types...)\nrequest.accepts(types)\nrequest.acceptsEncodings(encodings)\nrequest.acceptsCharsets(charsets)\nrequest.acceptsLanguages(langs)\nrequest.socket      //Return the request socket.\nrequest.get(field)  //Return request header.'),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n#### Response\n")),Object(i.b)("p",null,"response.header / response.headers\nresponse.status / response.status=\nresponse.message / response.message=\nresponse.length / response.length="),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),'<ul>\n<li>100 "continue"</li>\n<li>101 "switching protocols"</li>\n<li>102 "processing"</li>\n<li>200 "ok"</li>\n<li>201 "created"</li>\n<li>202 "accepted"</li>\n<li>203 "non-authoritative information"</li>\n<li>204 "no content"</li>\n<li>205 "reset content"</li>\n<li>206 "partial content"</li>\n<li>207 "multi-status"</li>\n<li>208 "already reported"</li>\n<li>226 "im used"</li>\n<li>300 "multiple choices"</li>\n<li>301 "moved permanently"</li>\n<li>302 "found"</li>\n<li>303 "see other"</li>\n<li>304 "not modified"</li>\n<li>305 "use proxy"</li>\n<li>307 "temporary redirect"</li>\n<li>308 "permanent redirect"</li>\n<li>400 "bad request"</li>\n<li>401 "unauthorized"</li>\n<li>402 "payment required"</li>\n<li>403 "forbidden"</li>\n<li>404 "not found"</li>\n<li>405 "method not allowed"</li>\n<li>406 "not acceptable"</li>\n<li>407 "proxy authentication required"</li>\n<li>408 "request timeout"</li>\n<li>409 "conflict"</li>\n<li>410 "gone"</li>\n<li>411 "length required"</li>\n<li>412 "precondition failed"</li>\n<li>413 "payload too large"</li>\n<li>414 "uri too long"</li>\n<li>415 "unsupported media type"</li>\n<li>416 "range not satisfiable"</li>\n<li>417 "expectation failed"</li>\n<li>418 "I\'m a teapot"</li>\n<li>422 "unprocessable entity"</li>\n<li>423 "locked"</li>\n<li>424 "failed dependency"</li>\n<li>426 "upgrade required"</li>\n<li>428 "precondition required"</li>\n<li>429 "too many requests"</li>\n<li>431 "request header fields too large"</li>\n<li>500 "internal server error"</li>\n<li>501 "not implemented"</li>\n<li>502 "bad gateway"</li>\n<li>503 "service unavailable"</li>\n<li>504 "gateway timeout"</li>\n<li>505 "http version not supported"</li>\n<li>506 "variant also negotiates"</li>\n<li>507 "insufficient storage"</li>\n<li>508 "loop detected"</li>\n<li>510 "not extended"</li>\n<li>511 "network authentication required"</li>\n</ul>\n\n')),Object(i.b)("p",null,"response.body / response.body="),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"<ul>\n<li><code>string</code> written</li>\n<li><code>Buffer</code> written</li>\n<li><code>Stream</code> piped</li>\n<li><code>Object</code> || <code>Array</code> json-stringified</li>\n<li><code>null</code> no content response</li>\n</ul>\n\nkoa with createReadStream\n")),Object(i.b)("p",null,"const filedir='/xx/ss/ss.json'"),Object(i.b)("p",null,"ctx.type = path.extname(filedir)\nctx.body=fs.createReadStream(filedir)"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n\n")),Object(i.b)("p",null,"response.get(field)\nresponse.set(field, value)\nresponse.append(field, value)\nresponse.set(fields)\nresponse.remove(field)"),Object(i.b)("p",null,"response.type / response.type=\nresponse.redirect(url, ","[alt]",")\nresponse.lastModified / response.lastModified=\nresponse.flushHeaders() // Flush any set headers, and begin the body."),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"\n------------------------------------------\n\n\n\n### \u5e38\u7528`midware`\n\n- #### [`koa-compose`](https://github.com/koajs/compose)\n>compose several middleware into one\n\n`install`\n")),Object(i.b)("p",null,"npm install koa-compose"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"`use`\n")),Object(i.b)("p",null,"// a,b,c is koa middware functions\ncompose(","[a, b, c, ...]",")"),Object(i.b)("p",null,"//return a koa middware functions can be used directly"),Object(i.b)("p",null,"const mid=compose(","[a,b]",")\n...\napp.use(mid)"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{}),"")))}p.isMDXComponent=!0},228:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=r.a.createContext({}),p=function(e){var t=r.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},b=function(e){var t=p(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),b=p(n),d=a,m=b["".concat(o,".").concat(d)]||b[d]||u[d]||i;return n?r.a.createElement(m,c(c({ref:t},s),{},{components:n})):r.a.createElement(m,c({ref:t},s))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,o[1]=c;for(var s=2;s<i;s++)o[s]=n[s];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);